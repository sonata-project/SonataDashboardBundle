/**
 *
 * This file is part of the Sonata package.
 *
 * (c) Thomas Rabaix <thomas.rabaix@sonata-project.org>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 *
 * generated on: Tue Jul 05 2016 00:13:23 GMT+0200 (CEST)
 * revision:     4a395c83a5bfe7520ea8b17a2079949e40083178
 *
 */
var Sonata=Sonata||{};Sonata.Dashboard={debug:!1,blocks:[],containers:[],data:[],blockSelector:".cms-block",containerSelector:".cms-container",dropPlaceHolderClass:"cms-block-placeholder",dropPlaceHolderSize:100,dropZoneClass:"cms-container-drop-zone",blockHoverClass:"cms-block-hand-over",url:{block_save_position:null,block_edit:null},init:function(t){t=t||[];for(property in t)this[property]=t[property];this.initInterface(),this.initBlocks(),this.initContainers(),this.initBlockData()},initInterface:function(){jQuery("#dashboard-action-enabled-edit").change(jQuery.proxy(this.toggleEditMode,this)),jQuery("#dashboard-action-save-position").click(jQuery.proxy(this.saveBlockLayout,this))},initBlocks:function(){this.blocks=jQuery(this.blockSelector),this.blocks.mouseover(jQuery.proxy(this.handleBlockHover,this)),this.blocks.dblclick(jQuery.proxy(this.handleBlockClick,this))},initContainers:function(){this.containers=jQuery(this.containerSelector),this.containers.sortable({connectWith:this.containerSelector,items:this.blockSelector,placeholder:this.dropPlaceHolderClass,helper:"clone",dropOnEmpty:!0,forcePlaceholderSize:this.dropPlaceHolderSize,opacity:1,cursor:"move",start:jQuery.proxy(this.startContainerSort,this),stop:jQuery.proxy(this.stopContainerSort,this)}).sortable("disable")},initBlockData:function(){this.data=this.buildBlockData()},startContainerSort:function(t,o){this.containers.addClass(this.dropZoneClass),this.containers.append(jQuery('<div class="cms-fake-block">&nbsp;</div>'))},stopContainerSort:function(t,o){this.containers.removeClass(this.dropZoneClass),jQuery("div.cms-fake-block").remove(),this.refreshLayers()},handleBlockClick:function(t){var o=t.currentTarget,a=jQuery(o).attr("data-id");window.open(this.url.block_edit.replace(/BLOCK_ID/,a),"_newtab"),t.preventDefault(),t.stopPropagation()},handleBlockHover:function(t){this.blocks.removeClass(this.blockHoverClass),jQuery(this).addClass(this.blockHoverClass),t.stopPropagation()},toggleEditMode:function(t){t&&t.currentTarget.checked?(jQuery("body").addClass("cms-edit-mode"),jQuery(".cms-container").sortable("enable"),this.buildLayers()):(jQuery("body").removeClass("cms-edit-mode"),jQuery("div.cms-container").sortable("disable"),this.removeLayers()),t.preventDefault(),t.stopPropagation()},buildLayers:function(){this.blocks.each(function(t){var o,a=jQuery(this),e=a.attr("data-role")||"block",i=a.attr("data-name")||"missing data-name",r=(a.attr("data-id")||"missing data-id",[]);r.push("cms-layout-layer"),r.push("cms-layout-role-"+e),o=jQuery('<div class="'+r.join(" ")+'" ></div>'),o.css({position:"absolute",left:0,top:0,width:"100%",height:"100%",zIndex:2}),title=jQuery('<div class="cms-layout-title"></div>'),title.css({position:"absolute",left:0,top:0,zIndex:2}),title.html("<span>"+i+"</span>"),o.append(title),a.prepend(o)})},removeLayers:function(){jQuery(".cms-layout-layer").remove()},refreshLayers:function(){jQuery(".cms-layout-layer").each(function(t){var o=jQuery(this),a=o.parent();o.css("width",a.width()),o.css("height",a.height())})},buildBlockData:function(){var t=[];return this.blocks.each(jQuery.proxy(function(o,a){var e=this.buildSingleBlockData(a);e&&t.push(e)},this)),t.sort(function(t,o){return t.dashboard_id==o.dashboard_id?t.parent_id==o.parent_id?t.position-o.position:t.parent_id-o.parent_id:t.dashboard_id-o.dashboard_id}),t},buildSingleBlockData:function(t){var o,a,e,i,r,n,s;return o=jQuery(t),(a=o.attr("data-id"))?(e=this.findParentContainer(o))?(i=jQuery(e).attr("data-id"),root=this.findRootContainer(o),root?(r=jQuery(root).attr("data-dashboard-id"),n=o.prevAll(this.blockSelector+"[data-id]"),s=n.length+1,a&&i?{id:a,position:s,parent_id:i,dashboard_id:r}:void 0):void this.log("Block "+a+" has no root but has a parent, should never happen!")):void this.log("Block "+a+" has no parent, it must be a root container, ignored"):void this.log("Block has no data-id, ignored !")},buildDiffBlockData:function(t,o){var a=[];return jQuery.map(t,function(t,e){var i;i=jQuery.grep(o,function(o,a){return t.id!=o.id?!1:t.position!=o.position||t.parent_id!=o.parent_id||t.dashboard_id!=o.dashboard_id?!0:void 0}),i&&i[0]&&a.push(i[0])}),a},findParentContainer:function(t){var o,a;return o=jQuery(t).parents(this.containerSelector+"[data-id]"),a=o.get(0)},findRootContainer:function(t){var o,a;return o=jQuery(t).parents(this.containerSelector+"[data-id]"),a=o.get(-1)},saveBlockLayout:function(t){var o;return t.preventDefault(),t.stopPropagation(),o=this.buildDiffBlockData(this.data,this.buildBlockData()),0==o.length?void alert("No changes found."):(jQuery.each(o,jQuery.proxy(function(t,o){this.log("Update block "+o.id+" (Dashboard "+o.dashboard_id+"), parent "+o.parent_id+", at position "+o.position+")")},this)),void jQuery.ajax({type:"POST",url:this.url.block_save_position,data:{disposition:o},dataType:"json",success:jQuery.proxy(function(t,o,a){"ok"==t.result?(alert("Block ordering saved!"),this.initBlockData()):(this.log(t),alert("Server could not save block ordering!"))},this),error:jQuery.proxy(function(t,o,a){this.log("Unable to save block ordering: "+a),this.log(o),this.log(t)},this)}))},log:function(){if(this.debug)try{console.log(arguments)}catch(t){}}}(function(t){function o(o){var a=t('<div class="overlay"><div class="fa fa-refresh fa-spin"></div></div>');return o.find(".overlay-wrapper").css("position","relative"),o.find(".overlay-wrapper").append(a),t.ajax(o.data("url")).done(function(t){o.find(".url-data").html(t)}).fail(function(t){o.find(".url-data").html('<div class="fa fa-remove text-danger"></div>')}).always(function(){o.find(a).remove()})}t(function(){t(".sonata-dashboard-ajax-block").each(function(a,e){var i=t(e);o(i)}),t(document).on("click",".sonata-dashboard-ajax-block__refresh-btn",function(a){var e=t(a.target).closest(".sonata-dashboard-ajax-block");o(e)})})}(jQuery));