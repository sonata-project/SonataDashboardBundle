/**
 *
 * This file is part of the Sonata package.
 *
 * (c) Thomas Rabaix <thomas.rabaix@sonata-project.org>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 *
 * generated on: Tue Aug 04 2015 10:50:45 GMT+0200 (CEST)
 * revision:     f7e1fda71983847558495691f9c05f821dd79de4
 *
 */
var Sonata=Sonata||{};Sonata.Dashboard={debug:!1,blocks:[],containers:[],data:[],blockSelector:".cms-block",containerSelector:".cms-container",dropPlaceHolderClass:"cms-block-placeholder",dropPlaceHolderSize:100,dropZoneClass:"cms-container-drop-zone",blockHoverClass:"cms-block-hand-over",url:{block_save_position:null,block_edit:null},init:function(t){t=t||[];for(property in t)this[property]=t[property];this.initInterface(),this.initBlocks(),this.initContainers(),this.initBlockData()},initInterface:function(){jQuery("#dashboard-action-enabled-edit").change(jQuery.proxy(this.toggleEditMode,this)),jQuery("#dashboard-action-save-position").click(jQuery.proxy(this.saveBlockLayout,this))},initBlocks:function(){this.blocks=jQuery(this.blockSelector),this.blocks.mouseover(jQuery.proxy(this.handleBlockHover,this)),this.blocks.dblclick(jQuery.proxy(this.handleBlockClick,this))},initContainers:function(){this.containers=jQuery(this.containerSelector),this.containers.sortable({connectWith:this.containerSelector,items:this.blockSelector,placeholder:this.dropPlaceHolderClass,helper:"clone",dropOnEmpty:!0,forcePlaceholderSize:this.dropPlaceHolderSize,opacity:1,cursor:"move",start:jQuery.proxy(this.startContainerSort,this),stop:jQuery.proxy(this.stopContainerSort,this)}).sortable("disable")},initBlockData:function(){this.data=this.buildBlockData()},startContainerSort:function(t,o){this.containers.addClass(this.dropZoneClass),this.containers.append(jQuery('<div class="cms-fake-block">&nbsp;</div>'))},stopContainerSort:function(t,o){this.containers.removeClass(this.dropZoneClass),jQuery("div.cms-fake-block").remove(),this.refreshLayers()},handleBlockClick:function(t){var o=t.currentTarget,e=jQuery(o).attr("data-id");window.open(this.url.block_edit.replace(/BLOCK_ID/,e),"_newtab"),t.preventDefault(),t.stopPropagation()},handleBlockHover:function(t){this.blocks.removeClass(this.blockHoverClass),jQuery(this).addClass(this.blockHoverClass),t.stopPropagation()},toggleEditMode:function(t){t&&t.currentTarget.checked?(jQuery("body").addClass("cms-edit-mode"),jQuery(".cms-container").sortable("enable"),this.buildLayers()):(jQuery("body").removeClass("cms-edit-mode"),jQuery("div.cms-container").sortable("disable"),this.removeLayers()),t.preventDefault(),t.stopPropagation()},buildLayers:function(){this.blocks.each(function(t){var o,e=jQuery(this),i=e.attr("data-role")||"block",a=e.attr("data-name")||"missing data-name",r=(e.attr("data-id")||"missing data-id",[]);r.push("cms-layout-layer"),r.push("cms-layout-role-"+i),o=jQuery('<div class="'+r.join(" ")+'" ></div>'),o.css({position:"absolute",left:0,top:0,width:"100%",height:"100%",zIndex:2}),title=jQuery('<div class="cms-layout-title"></div>'),title.css({position:"absolute",left:0,top:0,zIndex:2}),title.html("<span>"+a+"</span>"),o.append(title),e.prepend(o)})},removeLayers:function(){jQuery(".cms-layout-layer").remove()},refreshLayers:function(){jQuery(".cms-layout-layer").each(function(t){var o=jQuery(this),e=o.parent();o.css("width",e.width()),o.css("height",e.height())})},buildBlockData:function(){var t=[];return this.blocks.each(jQuery.proxy(function(o,e){var i=this.buildSingleBlockData(e);i&&t.push(i)},this)),t.sort(function(t,o){return t.dashboard_id==o.dashboard_id?t.parent_id==o.parent_id?t.position-o.position:t.parent_id-o.parent_id:t.dashboard_id-o.dashboard_id}),t},buildSingleBlockData:function(t){var o,e,i,a,r,s,n;return o=jQuery(t),(e=o.attr("data-id"))?(i=this.findParentContainer(o))?(a=jQuery(i).attr("data-id"),root=this.findRootContainer(o),root?(r=jQuery(root).attr("data-dashboard-id"),s=o.prevAll(this.blockSelector+"[data-id]"),n=s.length+1,e&&a?{id:e,position:n,parent_id:a,dashboard_id:r}:void 0):void this.log("Block "+e+" has no root but has a parent, should never happen!")):void this.log("Block "+e+" has no parent, it must be a root container, ignored"):void this.log("Block has no data-id, ignored !")},buildDiffBlockData:function(t,o){var e=[];return jQuery.map(t,function(t,i){var a;a=jQuery.grep(o,function(o,e){return t.id!=o.id?!1:t.position!=o.position||t.parent_id!=o.parent_id||t.dashboard_id!=o.dashboard_id?!0:void 0}),a&&a[0]&&e.push(a[0])}),e},findParentContainer:function(t){var o,e;return o=jQuery(t).parents(this.containerSelector+"[data-id]"),e=o.get(0)},findRootContainer:function(t){var o,e;return o=jQuery(t).parents(this.containerSelector+"[data-id]"),e=o.get(-1)},saveBlockLayout:function(t){var o;return t.preventDefault(),t.stopPropagation(),o=this.buildDiffBlockData(this.data,this.buildBlockData()),0==o.length?void alert("No changes found."):(jQuery.each(o,jQuery.proxy(function(t,o){this.log("Update block "+o.id+" (Dashboard "+o.dashboard_id+"), parent "+o.parent_id+", at position "+o.position+")")},this)),void jQuery.ajax({type:"POST",url:this.url.block_save_position,data:{disposition:o},dataType:"json",success:jQuery.proxy(function(t,o,e){"ok"==t.result?(alert("Block ordering saved!"),this.initBlockData()):(this.log(t),alert("Server could not save block ordering!"))},this),error:jQuery.proxy(function(t,o,e){this.log("Unable to save block ordering: "+e),this.log(o),this.log(t)},this)}))},log:function(){if(this.debug)try{console.log(arguments)}catch(t){}}};