/**
 *
 * This file is part of the Sonata package.
 *
 * (c) Thomas Rabaix <thomas.rabaix@sonata-project.org>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 *
 * generated on: Tue Jul 05 2016 00:13:24 GMT+0200 (CEST)
 * revision:     4a395c83a5bfe7520ea8b17a2079949e40083178
 *
 */
!function(e,n){function a(e){"undefined"==typeof n.admin&&Admin.shared_setup(e)}var o=function(n,a){var o=a||{};this.dashboardId=n,this.$container=e(".dashboard-composer"),this.$dynamicArea=e(".dashboard-composer__dyn-content"),this.$dashboardPreview=e(".dashboard-composer__dashboard-preview"),this.$containerPreviews=this.$dashboardPreview.find(".dashboard-composer__dashboard-preview__container"),this.$containersArea=this.$dashboardPreview.find(".dashboard-composer__dashboard-preview__containers"),this.routes=e.extend({},o.routes||{}),this.translations=e.extend({},o.translations||{}),this.csrfTokens={},this.bindDashboardPreviewHandlers(),this.bindAddContainer();var t=this,r=e(this);r.on("containerclick",function(e){t.loadContainer(e.$container)}),r.on("containerloaded",this.handleContainerLoaded),r.on("blockcreated",this.handleBlockCreated),r.on("blockremoved",this.handleBlockRemoved),r.on("blockcreateformloaded",this.handleBlockCreateFormLoaded),r.on("blockpositionsupdate",this.handleBlockPositionsUpdate),r.on("blockeditformloaded",this.handleBlockEditFormLoaded),r.on("blockparentswitched",this.handleBlockParentSwitched),r.on("blockcontainerformloaded",this.handleContainerEditFormLoaded)};o.prototype={translate:function(e){return this.translations[e]?this.translations[e]:e},getRouteUrl:function(e,n){if(!this.routes[e])throw new Error('Route "'+e+'" does not exist');var a=this.routes[e];for(var o in n)a=a.replace(new RegExp(o),n[o]);return a},isFormControlTypeByName:function(e,n){if("undefined"!=typeof e){var a=e.length,o="["+n+"]",t=e.lastIndexOf(o),a=a-o.length;return-1!==t&&t===a}return!1},handleBlockCreated:function(n){var a=this;e.ajax({url:this.getRouteUrl("block_preview",{BLOCK_ID:n.blockId}),type:"GET",success:function(o){var t=e(o);n.$childBlock.replaceWith(t),a.controlChildBlock(t);var r=a.getContainerChildCountFromList(n.parentId);null!==r&&a.updateChildCount(n.parentId,r)},error:function(){a.containerNotification("preview_error","error",!0)}})},handleBlockRemoved:function(e){var n=this.getContainerChildCountFromList(e.parentId);null!==n&&this.updateChildCount(e.parentId,n)},containerNotification:function(n,a,o){var t=this.$dynamicArea.find(".dashboard-composer__container__view__notice");if(1===t.length)if(this.containerNotificationTimer&&clearTimeout(this.containerNotificationTimer),t.removeClass("persist success error"),a&&t.addClass(a),t.text(this.translate(n)),t.show(),o!==!0)this.containerNotificationTimer=setTimeout(function(){t.hide().empty()},2e3);else{var r=e('<span class="close-notice">x</span>');r.on("click",function(){t.hide().empty()}),t.addClass("persist"),t.append(r)}},handleBlockPositionsUpdate:function(n){var a=this;this.containerNotification("update_saving"),e.ajax({url:this.getRouteUrl("save_blocks_positions",{BLOCK_ID:n.parent_id}),type:"POST",data:{disposition:n.disposition},success:function(e){e.result&&"ok"===e.result&&a.containerNotification("update_saved","success")},error:function(){a.containerNotification("update_error","error",!0)}})},handleBlockParentSwitched:function(n){var a=e(".block-preview-"+n.previousParentId),o=a.find(".child-count"),t=parseInt(o.text().trim(),10),r=e(".block-preview-"+n.newParentId),i=r.find(".child-count"),d=parseInt(i.text().trim(),10);this.updateChildCount(n.previousParentId,t-1),this.updateChildCount(n.newParentId,d+1)},getContainerChildCountFromList:function(n){var a=this.$dynamicArea.find(".block-view-"+n);if(0===a.length)return null;var o=a.find(".dashboard-composer__container__child"),t=0;return o.each(function(){var n=e(this),a=n.attr("data-block-id");"undefined"!=typeof a&&t++}),t},updateChildCount:function(n,a){var o=e(".block-preview-"+n),t=e(".block-view-"+n);o.length>0&&o.find(".child-count").text(a),t.length>0&&t.find(".dashboard-composer__container__child-count span").text(a)},handleBlockCreateFormLoaded:function(n){var o=this,t=this.$dynamicArea.find(".dashboard-composer__container__children"),r=this.$dynamicArea.find(".dashboard-composer__container__main-edition-area");if(n.container){var i=n.container,d=i.find(".dashboard-composer__container__child__content");d.html(n.response)}else{var i=e(['<li class="dashboard-composer__container__child">','<a class="dashboard-composer__container__child__edit">','<h4 class="dashboard-composer__container__child__name">','<input type="text" class="dashboard-composer__container__child__name__input">',"</h4>","</a>",'<div class="dashboard-composer__container__child__right">','<span class="badge">'+n.blockTypeLabel+"</span>","</div>",'<div class="dashboard-composer__container__child__content">',"</div>","</li>"].join("")),d=i.find(".dashboard-composer__container__child__content");d.append(n.response),t.append(i),d.show()}var c,s,l,_=i.find("form"),h=_.attr("action"),p=_.attr("method"),f=_.find("input, select, textarea"),u=_.find(".form-actions"),m=this.$dynamicArea.find(".dashboard-composer__container__child__name");a(_),e(document).scrollTo(i,200),r.show(),f.each(function(){var a=e(this),r=a.attr("name");o.isFormControlTypeByName(r,"name")?(c=a,m.find(".dashboard-composer__container__child__name__input").bind("propertychange keyup input paste",function(n){c.val(e(this).val())})):o.isFormControlTypeByName(r,"parent")?(s=a,s.val(n.containerId),s.parent().parent().hide()):o.isFormControlTypeByName(r,"position")&&(l=a,l.val(t.find("> *").length),l.closest(".form-group").hide())}),u.each(function(){var n=e(this),a=e('<span class="btn btn-warning">'+o.translate("cancel")+"</span>");a.on("click",function(n){n.preventDefault(),i.remove(),e(document).scrollTo(o.$dynamicArea,200)}),n.append(a)}),_.on("submit",function(t){t.preventDefault();var r=c.val();return""===r&&(r=n.blockType),e.ajax({url:h+"&"+e.param({composer:1}),data:_.serialize(),type:p,success:function(t){if(t.result&&"ok"===t.result&&t.objectId){var c=e.Event("blockcreated");c.$childBlock=i,c.parentId=n.containerId,c.blockId=t.objectId,c.blockName=r,c.blockType=n.blockType,e(o).trigger(c)}else{var s=e.Event("blockcreateformloaded");s.response=t,s.containerId=n.containerId,s.blockType=n.blockType,s.container=i,e(o).trigger(s),a(d)}}}),!1})},toggleChildBlock:function(e){var n="dashboard-composer__container__child--expanded",a=this.$dynamicArea.find(".dashboard-composer__container__child"),o=e.find(".dashboard-composer__container__child__name"),t=o.find(".dashboard-composer__container__child__name__input");e.hasClass(n)?(e.removeClass(n),o.has(".dashboard-composer__container__child__name__input")&&o.html(t.val())):(a.not(e).removeClass(n),e.addClass(n))},handleBlockEditFormLoaded:function(n){var o,t,r=this,i=n.$block.find(".dashboard-composer__container__child__edit h4"),d=n.$block.find(".dashboard-composer__container__child__content"),c=n.$block.find(".dashboard-composer__container__child__loader"),s=d.find("form"),l=s.attr("action"),_=s.attr("method"),h=n.$block.find(".dashboard-composer__container__child__edit small").text().trim();s.find("input").each(function(){var n=e(this),a=n.attr("name");r.isFormControlTypeByName(a,"name")?(o=n,i.html('<input type="text" class="dashboard-composer__container__child__name__input" value="'+i.text()+'">'),$input=i.find("input"),$input.bind("propertychange keyup input paste",function(e){o.val($input.val())}),$input.on("click",function(e){e.stopPropagation(),e.preventDefault()})):r.isFormControlTypeByName(a,"position")&&(t=n,t.closest(".form-group").hide())}),s.on("submit",function(t){return t.preventDefault(),c.show(),e.ajax({url:l,data:s.serialize(),type:_,success:function(t){if(c.hide(),t.result&&"ok"===t.result)"undefined"!=typeof o&&i.text(""!==o.val()?o.val():h),n.$block.removeClass("dashboard-composer__container__child--expanded"),d.empty();else{d.html(t);var s=e.Event("blockeditformloaded");s.$block=n.$block,e(r).trigger(s),a(d)}}}),!1})},controlChildBlock:function(n){var o=this,t=n.find(".dashboard-composer__container__child__content"),r=n.find(".dashboard-composer__container__child__loader"),i=n.find(".dashboard-composer__container__child__edit"),d=i.attr("href"),c=n.find(".dashboard-composer__container__child__remove"),s=c.find("a"),l=c.find(".dashboard-composer__container__child__remove__confirm"),_=l.find(".cancel"),h=l.find(".yes"),p=s.attr("href"),f=n.find(".dashboard-composer__container__child__switch-enabled"),u=f.attr("data-label-enable"),m=f.attr("data-label-disable"),b=f.find("a"),v=b.find("i"),k=n.find(".dashboard-composer__container__child__enabled"),g=k.find("small"),y=k.find("i"),w=b.attr("href"),C=parseInt(n.attr("data-block-enabled"),2);parentId=parseInt(n.attr("data-parent-block-id"),10),i.click(function(i){return i.preventDefault(),t.find("form").length>0?void o.toggleChildBlock(n):(r.show(),void e.ajax({url:d,success:function(i){t.html(i);var d=e.Event("blockeditformloaded");d.$block=n,e(o).trigger(d),a(t),r.hide(),o.toggleChildBlock(n)}}))}),b.on("click",function(a){a.preventDefault(),e.ajax({url:w,type:"POST",data:{_sonata_csrf_token:o.csrfTokens.switchEnabled,enabled:!C},success:function(a){if(a.status&&"OK"===a.status){if(n.attr("data-parent-block-enabled",!C),C=!C,b.toggleClass("bg-yellow bg-green"),v.toggleClass("fa-toggle-off fa-toggle-on"),C?b.html(m):b.html(u),g.toggleClass("bg-yellow bg-green"),y.toggleClass("fa-times fa-check"),n.has("form")){var t=n.find("form"),r=t.find("input");r.each(function(){var n=e(this),a=n.attr("name");o.isFormControlTypeByName(a,"enabled")&&n.val(parseInt(!C))})}}else o.containerNotification("status_error","error",!0)},error:function(){o.containerNotification("status_error","error",!0)}})}),s.on("click",function(e){e.preventDefault(),s.hide(),l.show()}),h.on("click",function(a){a.preventDefault(),e.ajax({url:p,type:"POST",data:{_method:"DELETE",_sonata_csrf_token:o.csrfTokens.remove},success:function(a){if(a.result&&"ok"===a.result){n.remove();var t=e.Event("blockremoved");t.parentId=parentId,e(o).trigger(t)}}})}),_.on("click",function(e){e.preventDefault(),l.hide(),s.show()})},handleContainerLoaded:function(n){var o=this,t=this.$dynamicArea.find(".dashboard-composer__container__children"),r=this.$dynamicArea.find(".dashboard-composer__container__child"),i=this.$dynamicArea.find(".dashboard-composer__block-type-selector"),d=i.find(".dashboard-composer__block-type-selector__loader"),c=i.find("select"),s=i.find(".dashboard-composer__block-type-selector__confirm"),l=this.$dynamicArea.find(".dashboard-composer__container__view__loader"),_=this.$dynamicArea.find(".dashboard-composer__container__settings"),h=this.$dynamicArea.find(".dashboard-composer__container__settings__content"),p=this.$dynamicArea.find(".dashboard-composer__container__view__cogs .btn"),f=_.data("href"),u=s.attr("href"),m=this.$containersArea.find(".dashboard-composer__dashboard-preview__container.active");a(this.$dynamicArea),s.on("click",function(a){a.preventDefault(),d.css("display","inline-block");var t=c.val(),r=c.find("option:selected").text();e.ajax({url:u,data:{type:t},success:function(a){d.hide(),e(o).trigger(e.Event("blockcreateformloaded",{response:a,containerId:n.containerId,blockType:t,blockTypeLabel:r}))}})}),t.sortable({revert:!0,cursor:"move",revertDuration:200,delay:200,helper:function(n,a){var o=e(a),t=o.find(".dashboard-composer__container__child__edit h4").text().trim();o.find(".dashboard-composer__container__child__edit small").text().trim();return o.removeClass("dashboard-composer__container__child--expanded"),e('<div class="dashboard-composer__container__child__helper"><h4>'+t+"</h4></div>")},update:function(n,a){var r=[];if(t.find(".dashboard-composer__container__child").each(function(n){var a=e(this),t=a.attr("data-parent-block-id"),i=a.attr("data-block-id");"undefined"!=typeof i&&r.push({id:parseInt(i,10),position:n,parent_id:parseInt(t,10),dashboard_id:o.dashboardId})}),r.length>0){var i=e.Event("blockpositionsupdate");i.disposition=r,i.parent_id=m.data("block-id"),e(o).trigger(i)}}}),p.on("click",function(n){l.show(),e.ajax({url:f,success:function(n){l.hide(),h.html(n);var t=e.Event("blockcontainerformloaded");e(o).trigger(t),a(m),_.toggle()}})}),r.each(function(){o.controlChildBlock(e(this))})},bindDashboardPreviewHandlers:function(n){var a=this;this.$containerPreviews.each(function(){var n=e(this),o=n.find(".removeContainer"),t=o.find(".badge"),r=o.find(".dashboard-composer__dashboard-preview__container__content__right__remove__confirm"),i=r.find(".cancel"),d=r.find(".yes"),c=t.data("href");t.unbind().on("click",function(e){t.hide(),r.show()}),d.unbind().on("click",function(o){e.ajax({url:c,type:"POST",data:{_method:"DELETE",_sonata_csrf_token:a.csrfTokens.remove},success:function(e){e.result&&"ok"===e.result&&(n.remove(),a.$containerPreviews=a.$dashboardPreview.find(".dashboard-composer__dashboard-preview__container"),a.$dynamicArea.empty(),a.bindDashboardPreviewHandlers())}})}),i.unbind().on("click",function(e){r.hide(),t.show()}),n.unbind().on("click",function(o){o.preventDefault();var t=e(o.target);if(!t.hasClass("removeContainer")&&0==t.parents(".removeContainer").length){var r=e.Event("containerclick");r.$container=n,e(a).trigger(r)}})}).droppable({hoverClass:"hover",tolerance:"pointer",revert:!0,connectToSortable:".dashboard-composer__container__children",drop:function(n,o){var t=o.draggable.attr("data-block-id");if("undefined"!=typeof t){o.helper.remove();var r=e(this),i=parseInt(o.draggable.attr("data-parent-block-id"),10),d=parseInt(r.attr("data-block-id"),10);t=parseInt(t,10),i!==d&&(r.addClass("dropped"),r.on("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(e){r.removeClass("dropped")}),e.ajax({url:a.getRouteUrl("block_switch_parent"),data:{block_id:t,parent_id:d},success:function(n){if(n.result&&"ok"===n.result){o.draggable.remove();var r=e.Event("blockparentswitched");r.previousParentId=i,r.newParentId=d,r.blockId=t,e(a).trigger(r)}}}))}}}),this.$containerPreviews.length>0&&(void 0==n?this.loadContainer(this.$containerPreviews.eq(0)):this.loadContainer(this.$containerPreviews.eq(n)))},loadContainer:function(n){var a=n.attr("href"),o=n.attr("data-block-id"),t=this;this.$dynamicArea.empty(),this.$containerPreviews.removeClass("active"),n.addClass("active"),e.ajax({url:a,success:function(n){t.$dynamicArea.html(n),e(document).scrollTo(t.$dynamicArea,200,{offset:{top:-100}});var a=e.Event("containerloaded");a.containerId=o,e(t).trigger(a)}})},bindAddContainer:function(){var n=this,a=this.$dashboardPreview.find(".dashboard-composer__block-container-header"),o=a.find(".dashboard-composer__block-container-header__loader"),t=a.find("input"),r=a.find(".dashboard-composer__block-container-header__confirm"),i=r.attr("href");r.on("click",function(a){a.preventDefault(),o.css("display","inline-block");var r=t.val();e.ajax({url:i,data:{name:r},success:function(e){o.hide(),t.val(""),n.$containersArea.append(e),n.$containerPreviews=n.$dashboardPreview.find(".dashboard-composer__dashboard-preview__container"),n.bindDashboardPreviewHandlers(n.$containerPreviews.length-1)}})})},handleContainerEditFormLoaded:function(n){var o=this,t=this.$dynamicArea.find(".dashboard-composer__container__settings"),r=t.find(".dashboard-composer__container__settings__content"),i=this.$containersArea.find(".dashboard-composer__dashboard-preview__container.active"),d=i.find("strong"),c=this.$dynamicArea.find(".dashboard-composer__container__view__loader"),s=r.find("form"),l=s.attr("action"),_=s.attr("method");s.unbind().on("submit",function(n){return n.preventDefault(),c.show(),e.ajax({url:l+"&"+e.param({composer:1}),data:s.serialize(),type:_,success:function(n){if(c.hide(),n.result&&"ok"===n.result&&n.objectId&&n.objectName)t.toggle(),d.html(n.objectName),o.loadContainer(o.$containerPreviews.eq(i.index()));else{var r=e.Event("blockcontainerformloaded");r.response=n,e(o).trigger(r),a(i)}}}),!1})}},n.DashboardComposer=o}(jQuery,window),function(e){function n(n){var a=e('<div class="overlay"><div class="fa fa-refresh fa-spin"></div></div>');return n.find(".overlay-wrapper").css("position","relative"),n.find(".overlay-wrapper").append(a),e.ajax(n.data("url")).done(function(e){n.find(".url-data").html(e)}).fail(function(e){n.find(".url-data").html('<div class="fa fa-remove text-danger"></div>')}).always(function(){n.find(a).remove()})}e(function(){e(".sonata-dashboard-ajax-block").each(function(a,o){var t=e(o);n(t)}),e(document).on("click",".sonata-dashboard-ajax-block__refresh-btn",function(a){var o=e(a.target).closest(".sonata-dashboard-ajax-block");n(o)})})}(jQuery);